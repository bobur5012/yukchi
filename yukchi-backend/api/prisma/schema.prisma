generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum UserRole {
  admin
  courier
}

enum CourierStatus {
  active
  inactive
}

enum TripStatus {
  planned
  active
  completed
  cancelled
}

enum ShopStatus {
  active
  inactive
}

enum NotificationStatus {
  pending
  sent
  failed
  retrying
}

enum NotificationChannel {
  bot
  client
}

enum AuditAction {
  create
  update
  delete
  login
  logout
  refresh
}

// ─── Users ────────────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(uuid()) @db.Uuid
  phone        String   @unique @db.VarChar(20)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  name         String   @db.VarChar(100)
  role         UserRole @default(admin)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  refreshTokens   RefreshToken[]
  auditLogs       AuditLog[]
  securityLogs    SecurityLog[]

  @@map("users")
}

// ─── Couriers ─────────────────────────────────────────────────────────────────

model Courier {
  id          String        @id @default(uuid()) @db.Uuid
  name        String        @db.VarChar(100)
  phone       String        @unique @db.VarChar(20)
  avatarUrl   String?       @map("avatar_url") @db.VarChar(500)
  status      CourierStatus @default(active)
  deletedAt   DateTime?     @map("deleted_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  tripCouriers TripCourier[]

  @@index([status])
  @@index([deletedAt])
  @@map("couriers")
}

// ─── Regions ──────────────────────────────────────────────────────────────────

model Region {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique @db.VarChar(100)
  nameUz    String   @map("name_uz") @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")

  trips Trip[]

  @@map("regions")
}

// ─── ExchangeRates ────────────────────────────────────────────────────────────

model ExchangeRate {
  id             String   @id @default(uuid()) @db.Uuid
  baseCurrency   String   @map("base_currency") @db.VarChar(10)
  targetCurrency String   @map("target_currency") @db.VarChar(10)
  rate           Decimal  @db.Decimal(18, 6)
  updatedAt      DateTime @updatedAt @map("updated_at")
  createdAt      DateTime @default(now()) @map("created_at")

  @@unique([baseCurrency, targetCurrency])
  @@index([baseCurrency, targetCurrency])
  @@map("exchange_rates")
}

// ─── Trips ────────────────────────────────────────────────────────────────────

model Trip {
  id            String     @id @default(uuid()) @db.Uuid
  name          String     @db.VarChar(200)
  departureDate DateTime   @map("departure_date") @db.Date
  returnDate    DateTime   @map("return_date") @db.Date
  budget        Decimal    @db.Decimal(18, 2)
  oldDebt       Decimal    @default(0) @map("old_debt") @db.Decimal(18, 2)
  currency      String     @db.VarChar(10)
  exchangeRate  Decimal    @map("exchange_rate") @db.Decimal(18, 6)
  budgetUsd     Decimal    @map("budget_usd") @db.Decimal(18, 2)
  status        TripStatus @default(planned)
  regionId      String     @map("region_id") @db.Uuid
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  region       Region        @relation(fields: [regionId], references: [id])
  tripCouriers TripCourier[]
  products     Product[]
  expenses     Expense[]

  @@index([status])
  @@index([departureDate])
  @@index([regionId])
  @@map("trips")
}

// ─── TripCouriers ─────────────────────────────────────────────────────────────

model TripCourier {
  id        String   @id @default(uuid()) @db.Uuid
  tripId    String   @map("trip_id") @db.Uuid
  courierId String   @map("courier_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  trip    Trip    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  courier Courier @relation(fields: [courierId], references: [id])

  @@unique([tripId, courierId])
  @@index([tripId])
  @@index([courierId])
  @@map("trip_couriers")
}

// ─── Products ─────────────────────────────────────────────────────────────────

model Product {
  id            String   @id @default(uuid()) @db.Uuid
  tripId        String   @map("trip_id") @db.Uuid
  name          String   @db.VarChar(200)
  quantity      Int
  costPrice     Decimal  @map("cost_price") @db.Decimal(18, 2)
  costPriceUsd  Decimal  @map("cost_price_usd") @db.Decimal(18, 2)
  imageUrl      String?  @map("image_url") @db.VarChar(500)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@map("products")
}

// ─── Expenses ─────────────────────────────────────────────────────────────────

model Expense {
  id          String   @id @default(uuid()) @db.Uuid
  tripId      String   @map("trip_id") @db.Uuid
  description String   @db.VarChar(300)
  amount      Decimal  @db.Decimal(18, 2)
  amountUsd   Decimal  @map("amount_usd") @db.Decimal(18, 2)
  currency    String   @db.VarChar(10)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@map("expenses")
}

// ─── Shops ────────────────────────────────────────────────────────────────────

model Shop {
  id          String     @id @default(uuid()) @db.Uuid
  name        String     @db.VarChar(200)
  ownerName   String     @map("owner_name") @db.VarChar(100)
  phone       String     @db.VarChar(20)
  address     String?    @db.VarChar(300)
  debt        Decimal    @default(0) @db.Decimal(18, 2)
  status      ShopStatus @default(active)
  deletedAt   DateTime?  @map("deleted_at")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  debtEntries      ShopDebtEntry[]
  notificationLogs NotificationLog[]

  @@index([status])
  @@index([deletedAt])
  @@index([debt])
  @@map("shops")
}

// ─── ShopDebtEntries ──────────────────────────────────────────────────────────

model ShopDebtEntry {
  id          String   @id @default(uuid()) @db.Uuid
  shopId      String   @map("shop_id") @db.Uuid
  amount      Decimal  @db.Decimal(18, 2)
  description String?  @db.VarChar(300)
  type        String   @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([createdAt])
  @@map("shop_debt_entries")
}

// ─── RefreshTokens ────────────────────────────────────────────────────────────

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  jti       String   @unique @db.VarChar(255)
  userId    String   @map("user_id") @db.Uuid
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jti])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ─── NotificationLog ──────────────────────────────────────────────────────────

model NotificationLog {
  id        String             @id @default(uuid()) @db.Uuid
  shopId    String?            @map("shop_id") @db.Uuid
  channel   NotificationChannel
  message   String             @db.Text
  status    NotificationStatus @default(pending)
  attempts  Int                @default(0)
  error     String?            @db.Text
  sentAt    DateTime?          @map("sent_at")
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  shop Shop? @relation(fields: [shopId], references: [id])

  @@index([status])
  @@index([shopId])
  @@index([channel])
  @@map("notification_log")
}

// ─── TelegramMessageLog ───────────────────────────────────────────────────────

model TelegramMessageLog {
  id          String   @id @default(uuid()) @db.Uuid
  phone       String   @db.VarChar(20)
  message     String   @db.Text
  messageId   String?  @map("message_id") @db.VarChar(100)
  status      String   @db.VarChar(20)
  error       String?  @db.Text
  floodWaitSeconds Int? @map("flood_wait_seconds")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([phone])
  @@index([status])
  @@index([createdAt])
  @@map("telegram_message_log")
}

// ─── AuditLog ─────────────────────────────────────────────────────────────────

model AuditLog {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  action     String    @db.VarChar(200)
  entityType String?   @map("entity_type") @db.VarChar(50)
  entityId   String?   @map("entity_id") @db.VarChar(100)
  metadata   Json?
  createdAt  DateTime  @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_log")
}

// ─── SecurityLog ──────────────────────────────────────────────────────────────

model SecurityLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  event     String   @db.VarChar(100)
  ip        String?  @db.VarChar(50)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([event])
  @@index([createdAt])
  @@map("security_log")
}
